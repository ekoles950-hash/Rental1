<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leonardo Studio Pro - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050507; color: #e2e8f0; }
        .glass { background: rgba(18, 18, 23, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top-color: #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 glass p-6 rounded-[2rem]">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2.5 rounded-2xl shadow-lg shadow-indigo-500/20">
                    <i data-lucide="video" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-extrabold text-xl tracking-tight">LEONARDO <span class="text-indigo-400">STUDIO</span></h1>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Video Engine v1.5</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <input type="password" id="apiKey" placeholder="Masukkan API Key..." 
                       class="bg-black/40 border border-white/10 px-4 py-2.5 rounded-xl text-xs outline-none focus:border-indigo-500 w-48 md:w-64">
                <button onclick="saveKey()" class="bg-white/5 hover:bg-white/10 p-2.5 rounded-xl border border-white/10 transition-all">
                    <i data-lucide="save" class="w-4 h-4 text-slate-400"></i>
                </button>
            </div>
        </header>

        <!-- Pesan Bantuan Proxy (Hanya muncul jika error) -->
        <div id="proxyHelper" class="hidden bg-yellow-500/10 border border-yellow-500/20 p-5 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-4 animate-pulse">
            <div class="flex items-center gap-3">
                <i data-lucide="shield-alert" class="text-yellow-500 w-6 h-6"></i>
                <p class="text-xs text-yellow-200/80"><strong>Penting:</strong> Klik tombol biru di sebelah kanan untuk mengaktifkan akses server sebelum memulai.</p>
            </div>
            <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" 
               class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black px-6 py-3 rounded-full shadow-lg shadow-blue-600/20 uppercase tracking-widest transition-all">
                Aktifkan Akses Sekarang
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Panel Kontrol -->
            <div class="lg:col-span-5 glass p-8 rounded-[2.5rem] space-y-6">
                
                <div id="errorMsg" class="hidden bg-red-500/10 border border-red-500/20 p-4 rounded-2xl flex gap-3 text-red-400 text-[11px] leading-relaxed">
                    <i data-lucide="alert-circle" class="shrink-0 w-4 h-4"></i>
                    <span id="errorTxt"></span>
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Resolusi Video</label>
                    <select id="res" class="w-full bg-black/40 border border-white/10 p-4 rounded-2xl text-sm outline-none focus:border-indigo-500">
                        <option value="9:16">9:16 Vertical (TikTok/Reels)</option>
                        <option value="16:9">16:9 Horizontal (YouTube)</option>
                        <option value="1:1">1:1 Square (Instagram)</option>
                    </select>
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Start Frame (Gambar Utama)</label>
                    <div onclick="document.getElementById('fileInput').click()" 
                         class="aspect-video border-2 border-dashed border-white/10 rounded-[2rem] flex flex-col items-center justify-center bg-black/20 cursor-pointer hover:bg-white/5 transition-all overflow-hidden" id="preview">
                        <i data-lucide="image-plus" class="text-slate-600 mb-2 w-10 h-10"></i>
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Pilih Gambar</p>
                    </div>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="loadImg(this)">
                </div>

                <div class="space-y-4">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Prom Animasi</label>
                    <textarea id="prompt" placeholder="Kamera zoom in perlahan..." 
                              class="w-full bg-black/40 border border-white/10 rounded-2xl p-5 text-sm min-h-[100px] outline-none focus:border-indigo-500"></textarea>
                </div>

                <button id="btn" onclick="proses()" class="btn-primary w-full py-5 rounded-[1.5rem] font-black text-xs flex items-center justify-center gap-3 uppercase tracking-widest shadow-xl">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                    <span>Generate Video</span>
                </button>

                <div id="loading" class="hidden flex items-center justify-center gap-3 p-4 bg-white/5 rounded-2xl border border-white/10">
                    <div class="spinner"></div>
                    <p id="status" class="text-xs font-bold text-indigo-400 uppercase tracking-widest">Memproses...</p>
                </div>
            </div>

            <!-- Panel Galeri -->
            <div class="lg:col-span-7 space-y-6">
                <h2 class="text-xl font-extrabold flex items-center gap-3">
                    <i data-lucide="play-circle" class="text-indigo-500 w-8 h-8"></i> HASIL RENDER
                </h2>
                <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Hasil akan muncul di sini -->
                    <div id="empty" class="col-span-full py-32 border-2 border-dashed border-white/5 rounded-[3rem] flex flex-col items-center justify-center text-slate-700">
                        <i data-lucide="film" class="w-16 h-16 opacity-10 mb-4"></i>
                        <p class="text-xs font-bold uppercase tracking-widest opacity-30">Belum ada karya</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fileObj = null;
        let proxy = "https://cors-anywhere.herokuapp.com/";

        lucide.createIcons();
        document.getElementById('apiKey').value = localStorage.getItem('leo_key') || '';

        function saveKey() {
            localStorage.setItem('leo_key', document.getElementById('apiKey').value);
            alert("API Key Berhasil Disimpan!");
        }

        function loadImg(input) {
            if (input.files[0]) {
                fileObj = input.files[0];
                const r = new FileReader();
                r.onload = e => {
                    document.getElementById('preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                r.readAsDataURL(fileObj);
            }
        }

        async function proses() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert("Masukkan API Key!");
            if(!fileObj) return alert("Pilih gambar!");

            const btn = document.getElementById('btn');
            const load = document.getElementById('loading');
            const err = document.getElementById('errorMsg');
            const helper = document.getElementById('proxyHelper');

            btn.disabled = true;
            btn.classList.add('hidden');
            load.classList.remove('hidden');
            err.classList.add('hidden');
            helper.classList.add('hidden');

            try {
                // 1. INIT IMAGE
                status("Mengunggah Gambar...");
                const initRes = await fetch(proxy + "https://cloud.leonardo.ai/api/rest/v1/init-image", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ extension: fileObj.name.split('.').pop() })
                });

                if(initRes.status === 403) throw new Error("PROXY_BLOCKED");
                if(!initRes.ok) throw new Error("API_KEY_INVALID");

                const initData = await initRes.json();
                const fields = JSON.parse(initData.uploadInitImage.fields);
                const formData = new FormData();
                Object.entries(fields).forEach(([k, v]) => formData.append(k, v));
                formData.append('file', fileObj);

                await fetch(initData.uploadInitImage.url, { method: 'POST', body: formData });

                // 2. GENERATE MOTION
                status("Mendaftarkan Render...");
                const genRes = await fetch(proxy + "https://cloud.leonardo.ai/api/rest/v1/generations-motion", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageId: initData.uploadInitImage.id, isPublic: false })
                });
                const genData = await genRes.json();

                // 3. POLLING
                status("Server Sedang Merender...");
                poll(genData.motionGenerationJob.motionId, key);

            } catch (e) {
                if(e.message === "PROXY_BLOCKED") {
                    helper.classList.remove('hidden');
                    error("Gagal! Anda perlu mengaktifkan akses Proxy terlebih dahulu.");
                } else if (e.message === "API_KEY_INVALID") {
                    error("API Key salah atau kredit akun Anda habis.");
                } else {
                    error(e.message);
                }
                resetUI();
            }
        }

        async function poll(id, key) {
            const intv = setInterval(async () => {
                const res = await fetch(proxy + `https://cloud.leonardo.ai/api/rest/v1/motions/${id}`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                const data = await res.json();
                const job = data.motion_generations_by_pk;

                if (job.status === 'COMPLETE') {
                    clearInterval(intv);
                    addVid(job.motionUrl, document.getElementById('prompt').value);
                    resetUI();
                } else if (job.status === 'FAILED') {
                    clearInterval(intv);
                    error("Gagal Render di Leonardo AI.");
                    resetUI();
                }
            }, 5000);
        }

        function addVid(url, prompt) {
            document.getElementById('empty').classList.add('hidden');
            const g = document.getElementById('gallery');
            const d = document.createElement('div');
            d.className = "glass p-4 rounded-[2rem] overflow-hidden animate-in fade-in zoom-in duration-500";
            d.innerHTML = `
                <video src="${url}" controls autoplay loop muted class="w-full rounded-2xl aspect-[9/16] object-cover bg-black"></video>
                <p class="mt-4 text-[10px] text-slate-500 italic px-2">"${prompt || 'Tanpa deskripsi'}"</p>
            `;
            g.prepend(d);
            lucide.createIcons();
        }

        function status(m) { document.getElementById('status').innerText = m; }
        function error(m) { document.getElementById('errorMsg').classList.remove('hidden'); document.getElementById('errorTxt').innerText = m; }
        function resetUI() {
            document.getElementById('btn').disabled = false;
            document.getElementById('btn').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }
    </script>
</body>
</html>