// api/leonardo.js
export default async function handler(req, res) {
    // 1. Menangani preflight request CORS (agar browser mengizinkan)
    if (req.method === 'OPTIONS') {
        res.status(200).setHeader('Access-Control-Allow-Origin', '*').setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS').setHeader('Access-Control-Allow-Headers', 'Content-Type');
        return res.end();
    }

    // Hanya menerima method POST
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    try {
        const payload = req.body;
        
        // 2. Ambil API Key dari Environment Variable Vercel (DIREKOMENDASIKAN)
        // Atau, jika Mas ingin cepat, Mas BISA menaruh API Key langsung di sini (ganti process.env.LEONARDO_API_KEY)
        const apiKey = process.env.LEONARDO_API_KEY || "TARUH_API_KEY_LEONARDO_MAS_DI_SINI";

        if (!apiKey || apiKey === "TARUH_API_KEY_LEONARDO_MAS_DI_SINI") {
             return res.status(500).json({ error: "API Key Leonardo belum disetting di backend Vercel." });
        }

        let response;

        // 3. Menentukan tujuan API Leonardo berdasarkan parameter 'action' dari frontend
        if (payload.action === 'init-image') {
            response = await fetch('https://cloud.leonardo.ai/api/rest/v1/init-image', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ extension: payload.extension })
            });
        } 
        else if (payload.action === 'render-video') {
            response = await fetch('https://cloud.leonardo.ai/api/rest/v1/generations-motion-svd', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload.data)
            });
        }
        else if (payload.action === 'check-status') {
             response = await fetch(`https://cloud.leonardo.ai/api/rest/v1/generations/${payload.generationId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Accept': 'application/json' }
            });
        }
        else {
            return res.status(400).json({ error: 'Action tidak dikenal' });
        }

        // 4. Mengembalikan respon dari Leonardo ke frontend
        const data = await response.json();
        
        // Tambahkan header CORS pada respon sukses
        res.setHeader('Access-Control-Allow-Origin', '*');
        res.status(response.status).json(data);

    } catch (error) {
        console.error("Backend Error:", error);
        res.setHeader('Access-Control-Allow-Origin', '*');
        res.status(500).json({ error: error.message || 'Terjadi kesalahan pada server Vercel.' });
    }
}