import React, { useState, useRef } from 'react';
import { Upload, X, Copy, Check, Sparkles, Loader2, Zap, Clapperboard, Mic, Video, FileWarning, User, UserCheck, AlertTriangle, FileText, Layers, FileAudio } from 'lucide-react';

// --- KOMPONEN TOMBOL SALIN ---
const CopyButton = ({ text, label }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <button 
      onClick={handleCopy}
      className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${
        copied 
          ? 'bg-green-500/10 border-green-500 text-green-400' 
          : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600 hover:text-white'
      }`}
    >
      {copied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
      {copied ? 'Disalin' : 'Salin'}
    </button>
  );
};

const TikTokUGCApp = () => {
  const [image, setImage] = useState(null);
  const [imageBase64, setImageBase64] = useState(null);
  const [instruction, setInstruction] = useState('');
  
  // State Output
  const [scenes, setScenes] = useState([]);
  const [rawText, setRawText] = useState(''); 
  const [isRawMode, setIsRawMode] = useState(false);
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  
  const [copiedAll, setCopiedAll] = useState(false);
  const [copiedNarration, setCopiedNarration] = useState(false);
  
  const [voiceGender, setVoiceGender] = useState('woman'); 
  const fileInputRef = useRef(null);

  const apiKey = ""; 

  // --- KONSTANTA TEKS (DIPERBARUI TOTAL) ---
  const technicalPrompt = "Negatif no watermark no subtile no logo. Narasi seorang kakek/nenek dengan suara lembut, maskulin menggunakan bahasa Indonesia. strictly no English language, strictly no foreign language narration, no English text, no English voiceover, language must not switch to English, avoid all non-Indonesian languages.";

  // --- LOGIC: Voice Hint (Kakek/Nenek) ---
  const getVoiceHint = () => {
    return voiceGender === 'man' 
      ? "Suara KAKEK Indonesia: Lembut, Maskulin, Bijaksana, Bahasa Indonesia Baku/Sopan." 
      : "Suara NENEK Indonesia: Lembut, Keibuan, Hangat, Bahasa Indonesia Baku/Sopan.";
  };

  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const base64String = reader.result.split(',')[1];
        const mimeType = reader.result.split(';')[0].split(':')[1];
        resolve({ base64: base64String, mimeType });
      };
      reader.onerror = (error) => reject(error);
    });
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const imageUrl = URL.createObjectURL(file);
      setImage(imageUrl);
      fileToBase64(file).then((data) => {
        setImageBase64(data);
      }).catch(err => setError("Gagal membaca gambar."));
      setError('');
      setScenes([]);
      setRawText('');
      setIsRawMode(false);
    }
  };

  const clearImage = () => {
    setImage(null);
    setImageBase64(null);
    setScenes([]);
    setRawText('');
    setIsRawMode(false);
    if (fileInputRef.current) fileInputRef.current.value = "";
  };

  // --- HANDLER: Generate UGC Script ---
  const handleGenerate = async () => {
    if (!imageBase64) {
      setError("Mohon unggah gambar produk terlebih dahulu.");
      return;
    }

    setLoading(true);
    setError('');
    setScenes([]);
    setRawText('');
    setIsRawMode(false);
    setCopiedAll(false);
    setCopiedNarration(false);

    try {
      const systemPrompt = `
        Anda adalah Penulis Skenario Video Senior Indonesia & Prompt Engineer.
        
        TUGAS:
        Analisis gambar produk, lalu buat SKENARIO VIDEO UGC (3 SCENE) dalam BAHASA INDONESIA MURNI untuk narasi, tapi sertakan Prompt Visual Bahasa Inggris yang spesifik.

        TARGET TALENT: ${voiceGender === 'man' ? 'KAKEK (Suara Maskulin Lembut)' : 'NENEK (Suara Lembut Keibuan)'}.

        ATURAN UTAMA:
        1. NARASI: WAJIB BAHASA INDONESIA 100%. DILARANG ADA BAHASA INGGRIS DI NARASI. Max 146 huruf.
        2. VISUAL: Gunakan deskripsi bahasa Indonesia dicampur prompt teknis bahasa Inggris untuk presisi.

        STRUKTUR SCENE (WAJIB IKUTI):

        SCENE 1 (HOOK - Opening Shot):
        - Visual Wajib: "Nenek/Kakek sudah duduk menghadap kamera. Frame awal KOSONG (tidak ada produk). Kamera statis, eye level. ${voiceGender === 'man' ? 'Kakek' : 'Nenek'} menoleh sedikit ke samping, lalu mengambil [PRODUK] dari LUAR FRAME kamera dengan gerakan pelan. Sebagian kecil [PRODUK] sudah mulai terlihat saat diambil, lalu diangkat dan ditunjukkan ke arah kamera.
          -- PROMPT TEKNIS (Sertakan ini): “The grandmother slowly picks up the sandal. A small part of the sandal is already visible at the start. She holds the same sandal steady for a moment, then shows it to the camera. The sandal must remain identical in shape, color, texture, and design throughout the shot. No object morphing or swapping. The grandmother’s appearance must remain consistent throughout the video.”"
        - Narasi: Kalimat pembuka hangat. Contoh: "Nak, nenek mau nunjukin sandal yang empuk dan nyaman dipakai."

        SCENE 2 (REVIEW):
        - Visual: Tangan talent mereview produk (mengelus/menunjuk detail).
        - Narasi: Penjelasan manfaat produk.

        SCENE 3 (CTA):
        - Visual: Talent mengajak beli.
        - Narasi: Ajakan checkout.

        PENTING: BERIKAN JAWABAN DALAM FORMAT JSON ARRAY SAJA.
        [
          { "scene": "1. HOOK (Opening)", "visual": "...", "audio": "..." },
          { "scene": "2. REVIEW (Detail)", "visual": "...", "audio": "..." },
          { "scene": "3. CTA (Closing)", "visual": "...", "audio": "..." }
        ]

        Instruksi tambahan user: ${instruction}
      `;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              role: "user",
              parts: [
                { text: systemPrompt },
                { inlineData: { mimeType: imageBase64.mimeType, data: imageBase64.base64 } }
              ]
            }],
            generationConfig: { responseMimeType: "application/json" }
          })
        }
      );

      const data = await response.json();
      
      if (!response.ok) throw new Error("Gagal menghubungi server AI.");

      const outputText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (outputText) {
        try {
          let cleanJson = outputText.replace(/```json/g, '').replace(/```/g, '').trim();
          const start = cleanJson.indexOf('[');
          const end = cleanJson.lastIndexOf(']');
          
          if (start !== -1 && end !== -1) {
            const jsonStr = cleanJson.substring(start, end + 1);
            const parsedScenes = JSON.parse(jsonStr);
            setScenes(parsedScenes);
            setIsRawMode(false);
          } else {
            throw new Error("Format JSON tidak valid");
          }
        } catch (parseErr) {
          console.warn("JSON Error", parseErr);
          setRawText(outputText);
          setIsRawMode(true);
        }
      } else {
        throw new Error("AI tidak memberikan respon.");
      }

    } catch (err) {
      console.error(err);
      setError("Gagal memproses. Coba refresh atau gunakan gambar lain.");
    } finally {
      setLoading(false);
    }
  };

  const handleCopyAll = () => {
    let contentToCopy = "";
    const header = `[Narator: ${getVoiceHint()}]\n[Teknis & Negative Prompt:\n${technicalPrompt}]\n\n`;

    if (isRawMode) {
      contentToCopy = header + rawText;
    } else if (scenes.length > 0) {
      contentToCopy = header;
      scenes.forEach((s) => {
        contentToCopy += `--- ${s.scene} ---\n`;
        contentToCopy += `VISUAL: ${s.visual}\n`;
        contentToCopy += `AUDIO: "${s.audio}"\n\n`;
      });
    }
    copyToClipboard(contentToCopy, setCopiedAll);
  };

  const handleCopyNarrationOnly = () => {
    if (scenes.length > 0) {
      const fullNarration = scenes.map(s => s.audio).join('\n\n');
      copyToClipboard(fullNarration, setCopiedNarration);
    }
  };

  const copyToClipboard = (text, setCopiedState) => {
    if (!text) return;
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    setCopiedState(true);
    setTimeout(() => setCopiedState(false), 2000);
  }

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center py-8 px-4 font-sans text-slate-800">
      
      {/* Header */}
      <div className="w-full max-w-md mb-6 text-center">
        <h1 className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-green-600 mb-2 flex items-center justify-center gap-2">
          <Clapperboard className="w-8 h-8 text-teal-600 fill-current" />
          UGC Master Hook
        </h1>
        <p className="text-slate-500 text-sm font-medium">
          Format Kakek/Nenek & Visual Presisi
        </p>
      </div>

      <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
        
        {/* Step 1: Upload */}
        <div className="p-6 border-b border-slate-100">
          <label className="block text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
            <span className="bg-teal-100 text-teal-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            Foto Produk
          </label>
          
          {!image ? (
            <div 
              onClick={() => fileInputRef.current.click()}
              className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer hover:bg-teal-50 hover:border-teal-400 transition-all duration-300 group"
            >
              <div className="bg-teal-50 p-3 rounded-full mb-3 group-hover:scale-110 transition-transform">
                <Upload className="w-6 h-6 text-teal-600" />
              </div>
              <p className="text-sm text-slate-500 font-medium text-center">
                Upload foto barang
              </p>
            </div>
          ) : (
            <div className="relative rounded-xl overflow-hidden border border-slate-200 bg-slate-100">
              <img src={image} alt="Preview" className="w-full h-64 object-cover" />
              <button 
                onClick={clearImage}
                className="absolute top-2 right-2 bg-white/90 p-1.5 rounded-full shadow-sm hover:bg-red-50 text-gray-600 hover:text-red-500 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          )}
          <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
        </div>

        {/* Step 2: Settings */}
        <div className="p-6 border-b border-slate-100 bg-slate-50/50">
          <div className="mb-4">
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
               <span className="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
               Pilih Narator (Indo Murni)
            </label>
            <div className="grid grid-cols-2 gap-3">
              <button onClick={() => setVoiceGender('woman')} className={`flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold border transition-all ${voiceGender === 'woman' ? 'bg-pink-100 border-pink-400 text-pink-700 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><UserCheck className="w-4 h-4" /> Nenek</button>
              <button onClick={() => setVoiceGender('man')} className={`flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold border transition-all ${voiceGender === 'man' ? 'bg-blue-100 border-blue-400 text-blue-700 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}><User className="w-4 h-4" /> Kakek</button>
            </div>
          </div>

          <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
            <span className="bg-teal-100 text-teal-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
            Info Tambahan (Opsional)
          </label>
          <div className="relative">
            <input type="text" value={instruction} onChange={(e) => setInstruction(e.target.value)} placeholder="Contoh: Sandal kulit asli..." className="w-full p-4 pr-10 text-sm border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-400 outline-none transition-shadow shadow-sm bg-white" />
            <Sparkles className="absolute right-3 top-3.5 w-4 h-4 text-teal-400 opacity-50 pointer-events-none" />
          </div>
        </div>

        {/* Action Button */}
        <div className="p-6 pb-2">
          {error && <div className="mb-4 p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center gap-2 animate-pulse"><AlertTriangle className="w-4 h-4" /> {error}</div>}
          
          <button onClick={handleGenerate} disabled={loading || !image} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 flex items-center justify-center gap-2 ${loading || !image ? 'bg-slate-300 cursor-not-allowed shadow-none' : 'bg-gradient-to-r from-teal-600 to-green-600 hover:shadow-green-500/30 hover:scale-[1.02] active:scale-95'}`}>
            {loading ? <><Loader2 className="w-5 h-5 animate-spin" /> Meracik Skenario...</> : <><Zap className="w-5 h-5 fill-current" /> Buat Skenario</>}
          </button>
        </div>

        {/* Step 3: Result */}
        {(scenes.length > 0 || isRawMode) && (
          <div className="p-6 pt-2 animate-in slide-in-from-bottom-5 fade-in duration-500">
            <div className="bg-gray-900 rounded-xl p-6 shadow-2xl text-white relative ring-4 ring-teal-400/20">
              
              <div className="absolute -top-3 left-6 bg-teal-500 text-white text-[10px] font-black px-2 py-1 rounded uppercase tracking-wider flex items-center gap-1">
                <Layers className="w-3 h-3" /> Struktur UGC
              </div>

              {/* Teknis */}
              <div className="mb-6 mt-2 pb-4 border-b border-gray-700">
                <div className="bg-gray-800 p-3 rounded border border-gray-600">
                   <div className="flex items-center justify-between mb-2">
                      <span className="text-[10px] text-red-400 font-bold uppercase flex items-center gap-1">
                        <FileWarning className="w-3 h-3" /> Panduan Teknis & Anti-Inggris:
                      </span>
                      <CopyButton text={technicalPrompt} label="Teknis" />
                   </div>
                   <p className="text-[10px] text-gray-400 font-mono leading-relaxed bg-black/40 p-2 rounded">{technicalPrompt}</p>
                </div>
              </div>

              {/* SCENES OUTPUT */}
              <div className="space-y-6 mb-6">
                {isRawMode ? (
                  <div className="bg-gray-800/50 rounded-lg p-3 border-l-2 border-teal-500">
                    <pre className="text-xs text-gray-300 whitespace-pre-wrap font-sans">{rawText}</pre>
                  </div>
                ) : (
                  scenes.map((scene, idx) => (
                    <div key={idx} className="relative group">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xs font-black text-teal-400 uppercase tracking-widest">{scene.scene}</span>
                        <div className="h-[1px] flex-grow bg-gray-700"></div>
                      </div>
                      
                      <div className="bg-gray-800/60 rounded-xl border border-gray-700 overflow-hidden">
                        {/* VISUAL */}
                        <div className="p-3 border-b border-gray-700/50 hover:bg-gray-800 transition-colors">
                          <div className="flex items-center justify-between mb-1.5">
                            <span className="text-[10px] font-bold text-blue-400 uppercase flex items-center gap-1"><Video className="w-3 h-3" /> Visual</span>
                            <CopyButton text={scene.visual} label="Visual" />
                          </div>
                          <p className="text-xs text-gray-300 leading-relaxed font-light">{scene.visual}</p>
                        </div>
                        {/* AUDIO */}
                        <div className="p-3 bg-gray-900/30 hover:bg-gray-900/50 transition-colors">
                          <div className="flex items-center justify-between mb-1.5">
                            <span className="text-[10px] font-bold text-green-400 uppercase flex items-center gap-1"><Mic className="w-3 h-3" /> Narasi (Indo Only)</span>
                            <CopyButton text={scene.audio} label="Narasi" />
                          </div>
                          <p className="text-sm font-medium text-white italic">"{scene.audio}"</p>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>

              {/* ACTION BUTTONS */}
              <div className="flex flex-col gap-3 pt-4 border-t border-gray-700">
                <button onClick={handleCopyNarrationOnly} className="w-full py-3 bg-slate-800 text-blue-400 border border-blue-900 hover:bg-slate-700 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all">
                  {copiedNarration ? <><Check className="w-4 h-4" /> Narasi Tersalin</> : <><FileAudio className="w-4 h-4" /> Salin Narasi Full (VO)</>}
                </button>
                <button onClick={handleCopyAll} className="w-full py-3 bg-green-600 text-white hover:bg-green-500 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-lg">
                  {copiedAll ? <><Check className="w-4 h-4" /> Semua Tersalin</> : <><Copy className="w-4 h-4" /> Salin Lengkap</>}
                </button>
              </div>

            </div>
          </div>
        )}
      </div>

      <p className="mt-8 text-center text-xs text-slate-400">
        AI Copywriter untuk Tiktok Affiliate
      </p>
    </div>
  );
};

export default TikTokUGCApp;